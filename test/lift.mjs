let fs = require("fs")
let tape = require("tape")
let R = require("ramda")
let vca = require("../dist/vca.js")

let Attr = vca.sql.Attr

const result0 = [
  { wt: 25.75, y: 485.626415094344, gear: 4, hp: 66 },
  { wt: 25.75, y: 101.4130695748969, gear: 5, hp: 335 },
  { wt: 25.75, y: 195.89337888492798, gear: 3, hp: 97 },
  { wt: 25.75, y: 206, gear: 5, hp: 175 },
  { wt: 25.75, y: 9.479673590510515, gear: 3, hp: 180 },
  { wt: 25.75, y: 119, gear: 3, hp: 105 },
  { wt: 25.75, y: 16, gear: 4, hp: 95 },
  { wt: 25.75, y: 374.5438751152047, gear: 4, hp: 65 },
  { wt: 25.75, y: 68.92063992640946, gear: 3, hp: 230 },
  { wt: 25.75, y: 21, gear: 4, hp: 110 },
  { wt: 25.75, y: 48.09197806058795, gear: 3, hp: 215 },
  { wt: 25.75, y: 119, gear: 3, hp: 110 },
  { wt: 25.75, y: 358.7974696699901, gear: 4, hp: 52 },
  { wt: 25.75, y: 129.1321219299339, gear: 4, hp: 123 },
  { wt: 25.75, y: 369.3262340731048, gear: 5, hp: 113 },
  { wt: 25.75, y: 46.24320987653931, gear: 3, hp: 175 },
  { wt: 25.75, y: -67.84814814815047, gear: 3, hp: 245 },
  { wt: 25.75, y: 25.75, gear: 3, hp: 205 },
  { wt: 25.75, y: 206, gear: 4, hp: 62 },
  { wt: 25.75, y: 177.96148205856736, gear: 4, hp: 109 },
  { wt: 25.75, y: 206, gear: 5, hp: 264 },
  { wt: 25.75, y: 210, gear: 3, hp: 10 },
  { wt: 25.75, y: 93.95882352951321, gear: 3, hp: 150 },
  { wt: 25.75, y: 261.43988816402606, gear: 5, hp: 91 },
  { wt: 25.75, y: 253.06034482758625, gear: 4, hp: 93 },
  { wt: 50.5, y: 961.94716981133, gear: 4, hp: 66 },
  { wt: 50.5, y: 197.83883476780483, gear: 5, hp: 335 },
  { wt: 50.5, y: 381.2588986359251, gear: 3, hp: 97 },
  { wt: 50.5, y: 404, gear: 5, hp: 175 },
  { wt: 50.5, y: 1.7682492581736824, gear: 3, hp: 180 },
  { wt: 50.5, y: 218, gear: 3, hp: 105 },
  { wt: 50.5, y: 16, gear: 4, hp: 95 },
  { wt: 50.5, y: 727.0814418767064, gear: 4, hp: 65 },
  { wt: 50.5, y: 134.6869147697633, gear: 3, hp: 230 },
  { wt: 50.5, y: 21, gear: 4, hp: 110 },
  { wt: 50.5, y: 93.98770063264107, gear: 3, hp: 215 },
  { wt: 50.5, y: 218, gear: 3, hp: 110 },
  { wt: 50.5, y: 695.5630538561205, gear: 4, hp: 52 },
  { wt: 50.5, y: 251.86385737439218, gear: 4, hp: 123 },
  { wt: 50.5, y: 715.426176034129, gear: 5, hp: 113 },
  { wt: 50.5, y: 76.79876543209105, gear: 3, hp: 175 },
  { wt: 50.5, y: -159.51481481482256, gear: 3, hp: 245 },
  { wt: 50.5, y: 50.5, gear: 3, hp: 205 },
  { wt: 50.5, y: 404, gear: 4, hp: 62 },
  { wt: 50.5, y: 346.6552861922, gear: 4, hp: 109 },
  { wt: 50.5, y: 404, gear: 5, hp: 264 },
  { wt: 50.5, y: 408, gear: 3, hp: 10 },
  { wt: 50.5, y: 181.31176470608443, gear: 3, hp: 150 },
  { wt: 50.5, y: 508.24790307548926, gear: 5, hp: 91 },
  { wt: 50.5, y: 496.29310344827593, gear: 4, hp: 93 },
  { wt: 75.25, y: 1438.2679245283161, gear: 4, hp: 66 },
  { wt: 75.25, y: 294.26459996071276, gear: 5, hp: 335 },
  { wt: 75.25, y: 566.6244183869222, gear: 3, hp: 97 },
  { wt: 75.25, y: 602, gear: 5, hp: 175 },
  { wt: 75.25, y: -5.94317507416315, gear: 3, hp: 180 },
  { wt: 75.25, y: 317, gear: 3, hp: 105 },
  { wt: 75.25, y: 16, gear: 4, hp: 95 },
  { wt: 75.25, y: 1079.6190086382085, gear: 4, hp: 65 },
  { wt: 75.25, y: 200.45318961311708, gear: 3, hp: 230 },
  { wt: 75.25, y: 21, gear: 4, hp: 110 },
  { wt: 75.25, y: 139.8834232046942, gear: 3, hp: 215 },
  { wt: 75.25, y: 317, gear: 3, hp: 110 },
  { wt: 75.25, y: 1032.3286380422508, gear: 4, hp: 52 },
  { wt: 75.25, y: 374.5955928188505, gear: 4, hp: 123 },
  { wt: 75.25, y: 1061.526117995153, gear: 5, hp: 113 },
  { wt: 75.25, y: 107.35432098764278, gear: 3, hp: 175 },
  { wt: 75.25, y: -251.18148148149464, gear: 3, hp: 245 },
  { wt: 75.25, y: 75.25, gear: 3, hp: 205 },
  { wt: 75.25, y: 602, gear: 4, hp: 62 },
  { wt: 75.25, y: 515.3490903258327, gear: 4, hp: 109 },
  { wt: 75.25, y: 602, gear: 5, hp: 264 },
  { wt: 75.25, y: 606, gear: 3, hp: 10 },
  { wt: 75.25, y: 268.66470588265565, gear: 3, hp: 150 },
  { wt: 75.25, y: 755.0559179869525, gear: 5, hp: 91 },
  { wt: 75.25, y: 739.5258620689657, gear: 4, hp: 93 },
  { wt: 100, y: 1914.588679245302, gear: 4, hp: 66 },
  { wt: 100, y: 390.6903651536207, gear: 5, hp: 335 },
  { wt: 100, y: 751.9899381379194, gear: 3, hp: 97 },
  { wt: 100, y: 800, gear: 5, hp: 175 },
  { wt: 100, y: -13.654599406499983, gear: 3, hp: 180 },
  { wt: 100, y: 416, gear: 3, hp: 105 },
  { wt: 100, y: 16, gear: 4, hp: 95 },
  { wt: 100, y: 1432.1565753997102, gear: 4, hp: 65 },
  { wt: 100, y: 266.2194644564709, gear: 3, hp: 230 },
  { wt: 100, y: 21, gear: 4, hp: 110 },
  { wt: 100, y: 185.7791457767473, gear: 3, hp: 215 },
  { wt: 100, y: 416, gear: 3, hp: 110 },
  { wt: 100, y: 1369.094222228381, gear: 4, hp: 52 },
  { wt: 100, y: 497.32732826330874, gear: 4, hp: 123 },
  { wt: 100, y: 1407.6260599561774, gear: 5, hp: 113 },
  { wt: 100, y: 137.9098765431945, gear: 3, hp: 175 },
  { wt: 100, y: -342.84814814816673, gear: 3, hp: 245 },
  { wt: 100, y: 100, gear: 3, hp: 205 },
  { wt: 100, y: 800, gear: 4, hp: 62 },
  { wt: 100, y: 684.0428944594653, gear: 4, hp: 109 },
  { wt: 100, y: 800, gear: 5, hp: 264 },
  { wt: 100, y: 804, gear: 3, hp: 10 },
  { wt: 100, y: 356.0176470592269, gear: 3, hp: 150 },
  { wt: 100, y: 1001.8639328984157, gear: 5, hp: 91 },
  { wt: 100, y: 982.7586206896553, gear: 4, hp: 93 }
]


const result1 = [
  { wt: 2.2, gear: 4, hp: 66, y: 64.79999999999973 },
  { wt: 1.935, gear: 4, hp: 66, y: 54.59999999999968 },
  { wt: 3.57, gear: 5, hp: 335, y: 30.000000000000004 },
  { wt: 2.465, gear: 3, hp: 97, y: 42.99999999999999 },
  { wt: 2.77, gear: 5, hp: 175, y: 41.86 },
  { wt: 3.73, gear: 3, hp: 180, y: 33.64050445103807 },
  { wt: 4.07, gear: 3, hp: 180, y: 32.63456973293728 },
  { wt: 3.78, gear: 3, hp: 180, y: 31.524925816023252 },
  { wt: 3.46, gear: 3, hp: 105, y: 47.94 },
  { wt: 3.15, gear: 4, hp: 95, y: 38.8 },
  { wt: 1.835, gear: 4, hp: 65, y: 67.79999999999998 },
  { wt: 5.345, gear: 3, hp: 230, y: 29.4 },
  { wt: 2.875, gear: 4, hp: 110, y: 42 },
  { wt: 2.62, gear: 4, hp: 110, y: 42 },
  { wt: 5.424, gear: 3, hp: 215, y: 20.799999999999997 },
  { wt: 3.215, gear: 3, hp: 110, y: 50.26 },
  { wt: 1.615, gear: 4, hp: 52, y: 60.800000000000004 },
  { wt: 3.44, gear: 4, hp: 123, y: 37 },
  { wt: 1.513, gear: 5, hp: 113, y: 60.8 },
  { wt: 3.44, gear: 3, hp: 175, y: 37.399999999999544 },
  { wt: 3.845, gear: 3, hp: 175, y: 38.39999999999948 },
  { wt: 3.57, gear: 3, hp: 245, y: 28.600000000002535 },
  { wt: 3.84, gear: 3, hp: 245, y: 26.600000000002474 },
  { wt: 5.25, gear: 3, hp: 205, y: 15.65 },
  { wt: 3.19, gear: 4, hp: 62, y: 49.92 },
  { wt: 2.78, gear: 4, hp: 109, y: 42.79999999999999 },
  { wt: 3.17, gear: 5, hp: 264, y: 41.16 },
  { wt: 2, gear: 3, hp: 10, y: 40 },
  { wt: 3.435, gear: 3, hp: 150, y: 30.400000000010714 },
  { wt: 3.52, gear: 3, hp: 150, y: 31.00000000001106 },
  { wt: 2.14, gear: 5, hp: 91, y: 52 },
  { wt: 2.32, gear: 4, hp: 93, y: 45.6 }
]


const result2 = [
  { wt: 25.75, gear: 3, hp: 10, y: 420 },
  { wt: 25.75, gear: 3, hp: 97, y: 391.78675776985597 },
  { wt: 25.75, gear: 3, hp: 105, y: 238 },
  { wt: 25.75, gear: 3, hp: 110, y: 238 },
  { wt: 25.75, gear: 3, hp: 150, y: 187.91764705902642 },
  { wt: 25.75, gear: 3, hp: 175, y: 92.48641975307862 },
  { wt: 25.75, gear: 3, hp: 180, y: 18.95934718102103 },
  { wt: 25.75, gear: 3, hp: 205, y: 51.5 },
  { wt: 25.75, gear: 3, hp: 215, y: 96.1839561211759 },
  { wt: 25.75, gear: 3, hp: 230, y: 137.84127985281893 },
  { wt: 25.75, gear: 3, hp: 245, y: -135.69629629630094 },
  { wt: 25.75, gear: 4, hp: 52, y: 717.5949393399802 },
  { wt: 25.75, gear: 4, hp: 62, y: 412 },
  { wt: 25.75, gear: 4, hp: 65, y: 749.0877502304094 },
  { wt: 25.75, gear: 4, hp: 66, y: 971.252830188688 },
  { wt: 25.75, gear: 4, hp: 93, y: 506.1206896551725 },
  { wt: 25.75, gear: 4, hp: 95, y: 32 },
  { wt: 25.75, gear: 4, hp: 109, y: 355.9229641171347 },
  { wt: 25.75, gear: 4, hp: 110, y: 42 },
  { wt: 25.75, gear: 4, hp: 123, y: 258.2642438598678 },
  { wt: 25.75, gear: 5, hp: 91, y: 522.8797763280521 },
  { wt: 25.75, gear: 5, hp: 113, y: 738.6524681462096 },
  { wt: 25.75, gear: 5, hp: 175, y: 412 },
  { wt: 25.75, gear: 5, hp: 264, y: 412 },
  { wt: 25.75, gear: 5, hp: 335, y: 202.8261391497938 },
  { wt: 50.5, gear: 3, hp: 10, y: 816 },
  { wt: 50.5, gear: 3, hp: 97, y: 762.5177972718502 },
  { wt: 50.5, gear: 3, hp: 105, y: 436 },
  { wt: 50.5, gear: 3, hp: 110, y: 436 },
  { wt: 50.5, gear: 3, hp: 150, y: 362.62352941216886 },
  { wt: 50.5, gear: 3, hp: 175, y: 153.5975308641821 },
  { wt: 50.5, gear: 3, hp: 180, y: 3.536498516347365 },
  { wt: 50.5, gear: 3, hp: 205, y: 101 },
  { wt: 50.5, gear: 3, hp: 215, y: 187.97540126528213 },
  { wt: 50.5, gear: 3, hp: 230, y: 269.3738295395266 },
  { wt: 50.5, gear: 3, hp: 245, y: -319.0296296296451 },
  { wt: 50.5, gear: 4, hp: 52, y: 1391.126107712241 },
  { wt: 50.5, gear: 4, hp: 62, y: 808 },
  { wt: 50.5, gear: 4, hp: 65, y: 1454.1628837534129 },
  { wt: 50.5, gear: 4, hp: 66, y: 1923.89433962266 },
  { wt: 50.5, gear: 4, hp: 93, y: 992.5862068965519 },
  { wt: 50.5, gear: 4, hp: 95, y: 32 },
  { wt: 50.5, gear: 4, hp: 109, y: 693.3105723844 },
  { wt: 50.5, gear: 4, hp: 110, y: 42 },
  { wt: 50.5, gear: 4, hp: 123, y: 503.72771474878436 },
  { wt: 50.5, gear: 5, hp: 91, y: 1016.4958061509785 },
  { wt: 50.5, gear: 5, hp: 113, y: 1430.852352068258 },
  { wt: 50.5, gear: 5, hp: 175, y: 808 },
  { wt: 50.5, gear: 5, hp: 264, y: 808 },
  { wt: 50.5, gear: 5, hp: 335, y: 395.67766953560965 },
  { wt: 75.25, gear: 3, hp: 10, y: 1212 },
  { wt: 75.25, gear: 3, hp: 97, y: 1133.2488367738445 },
  { wt: 75.25, gear: 3, hp: 105, y: 634 },
  { wt: 75.25, gear: 3, hp: 110, y: 634 },
  { wt: 75.25, gear: 3, hp: 150, y: 537.3294117653113 },
  { wt: 75.25, gear: 3, hp: 175, y: 214.70864197528556 },
  { wt: 75.25, gear: 3, hp: 180, y: -11.8863501483263 },
  { wt: 75.25, gear: 3, hp: 205, y: 150.5 },
  { wt: 75.25, gear: 3, hp: 215, y: 279.7668464093884 },
  { wt: 75.25, gear: 3, hp: 230, y: 400.90637922623415 },
  { wt: 75.25, gear: 3, hp: 245, y: -502.3629629629893 },
  { wt: 75.25, gear: 4, hp: 52, y: 2064.6572760845015 },
  { wt: 75.25, gear: 4, hp: 62, y: 1204 },
  { wt: 75.25, gear: 4, hp: 65, y: 2159.238017276417 },
  { wt: 75.25, gear: 4, hp: 66, y: 2876.5358490566323 },
  { wt: 75.25, gear: 4, hp: 93, y: 1479.0517241379314 },
  { wt: 75.25, gear: 4, hp: 95, y: 32 },
  { wt: 75.25, gear: 4, hp: 109, y: 1030.6981806516653 },
  { wt: 75.25, gear: 4, hp: 110, y: 42 },
  { wt: 75.25, gear: 4, hp: 123, y: 749.191185637701 },
  { wt: 75.25, gear: 5, hp: 91, y: 1510.111835973905 },
  { wt: 75.25, gear: 5, hp: 113, y: 2123.052235990306 },
  { wt: 75.25, gear: 5, hp: 175, y: 1204 },
  { wt: 75.25, gear: 5, hp: 264, y: 1204 },
  { wt: 75.25, gear: 5, hp: 335, y: 588.5291999214255 },
  { wt: 100, gear: 3, hp: 10, y: 1608 },
  { wt: 100, gear: 3, hp: 97, y: 1503.9798762758387 },
  { wt: 100, gear: 3, hp: 105, y: 832 },
  { wt: 100, gear: 3, hp: 110, y: 832 },
  { wt: 100, gear: 3, hp: 150, y: 712.0352941184537 },
  { wt: 100, gear: 3, hp: 175, y: 275.819753086389 },
  { wt: 100, gear: 3, hp: 180, y: -27.309198812999966 },
  { wt: 100, gear: 3, hp: 205, y: 200 },
  { wt: 100, gear: 3, hp: 215, y: 371.5582915534946 },
  { wt: 100, gear: 3, hp: 230, y: 532.4389289129418 },
  { wt: 100, gear: 3, hp: 245, y: -685.6962962963335 },
  { wt: 100, gear: 4, hp: 52, y: 2738.188444456762 },
  { wt: 100, gear: 4, hp: 62, y: 1600 },
  { wt: 100, gear: 4, hp: 65, y: 2864.3131507994203 },
  { wt: 100, gear: 4, hp: 66, y: 3829.177358490604 },
  { wt: 100, gear: 4, hp: 93, y: 1965.5172413793107 },
  { wt: 100, gear: 4, hp: 95, y: 32 },
  { wt: 100, gear: 4, hp: 109, y: 1368.0857889189306 },
  { wt: 100, gear: 4, hp: 110, y: 42 },
  { wt: 100, gear: 4, hp: 123, y: 994.6546565266175 },
  { wt: 100, gear: 5, hp: 91, y: 2003.7278657968313 },
  { wt: 100, gear: 5, hp: 113, y: 2815.252119912355 },
  { wt: 100, gear: 5, hp: 175, y: 1600 },
  { wt: 100, gear: 5, hp: 264, y: 1600 },
  { wt: 100, gear: 5, hp: 335, y: 781.3807303072414 }
]

tape("lift", async (test) => {
  let db = await vca.LocalDB()
  let VCA = vca.VCA({ app: {db: db}, View: vca.View })


  let v1 = vca.View({
    q: vca.parse("SELECT gear, hp, wt, avg(mpg) as y FROM cars "), 
    r: {x:"wt", y:"y", color: "gear", measure: "y"}
  })
  let op = {
    Af: [Attr({attr: "wt"})],
    Ac: [Attr({attr: "gear"}), Attr({attr: "hp"})],
    y: Attr({attr: "y"})
  }
  let bounds = [[op.Af[0], [1, 100]]]
  let v2 = await VCA.lift(op, v1)
  v2.q.setBounds(bounds, 4)
  test.deepEqual(await db.exec(v2.q.toSql().toString()), result0, "wt->y|gear,hp using linear")


  op = {
    Af: [Attr({attr: "wt"}), Attr("hp")],
    y: Attr({attr: "y"}),
    model: "glm"
  }
  bounds = [[op.Af[0], [1, 100]], [op.Af[1], [10, 300]]]
  let vl = await VCA.lift(op, v1)
  vl.q.setBounds(bounds, 2)
  test.deepEqual(await db.exec(vl.q.toSql().toString()), [
    { wt: 34, hp: 106.66666666666667, y: 0.01913412723891036 },
    { wt: 34, hp: 203.33333333333334, y: 0.01744768095746004 },
    { wt: 34, hp: 300, y: 0.015909874905308187 },
    { wt: 67, hp: 106.66666666666667, y: 0.000011154421842484743 },
    { wt: 67, hp: 203.33333333333334, y: 0.000010171291909088428 },
    { wt: 67, hp: 300, y: 0.000009274813214060962 },
    { wt: 100, hp: 106.66666666666667, y: 6.502576526567837e-9 },
    { wt: 100, hp: 203.33333333333334, y: 5.929451561621648e-9 },
    { wt: 100, hp: 300, y: 5.406840761960945e-9 }
  ], "wt,hp -> y using GLM")

  let v3 = await VCA.dot({
    label: "-",
    f: (a1, a2) => `${a1}+coalesce(${a2}, 0)`
  }, v2, v1)
  console.log("== v3 ==")
  let res = (await db.exec(v3.q.toSql().toString()))
  test.deepEqual(res, result1, "query+model")


  console.log("MODEL MODEL JOIN")
  let v4 = await VCA.dot({
    label: "-",
    f: (a1, a2) => `${a1}+coalesce(${a2}, 0)`
  }, v2, v2)
  console.log("== v4 ==")
  res = (await db.exec(v4.q.toSql().toString()))
  test.deepEqual(res, result2, "model+model")




  test.end();
})

